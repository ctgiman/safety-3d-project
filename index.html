<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 工安教學系統 (附座標偵測工具)</title>
    <style>
        body { margin: 0; font-family: 'Microsoft JhengHei', sans-serif; background: #2c3e50; color: white; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; }
        
        /* 右側資訊欄 */
        #info-panel {
            position: absolute; right: 0; top: 0; bottom: 0; width: 300px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            box-shadow: -5px 0 15px rgba(0,0,0,0.5);
        }
        h2 { color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .content-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; }

        /* 標籤樣式 */
        .annotation {
            position: absolute; width: 30px; height: 30px;
            background: rgba(0,0,0,0.6); border: 2px solid #fff; border-radius: 50%;
            cursor: pointer; color: #fff; font-weight: bold; text-align: center; line-height: 26px;
            transition: 0.2s;
        }
        .annotation:hover { transform: scale(1.2); background: #3498db; }
        .annotation.danger { border-color: #e74c3c; color: #e74c3c; }

        /* 除錯工具樣式 */
        #debug-tool {
            position: absolute; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.9); border: 1px solid #00ff00; color: #00ff00;
            padding: 10px; font-family: monospace; font-size: 14px; max-width: 400px;
        }
    </style>
</head>
<body>

    <div id="container">
        <div id="canvas-wrapper" style="width:100%; height:100%;"></div>

        <div id="labels-container"></div>

        <div id="info-panel">
            <h2 id="model-title">載入中...</h2>
            <div id="description" class="content-box">請稍候...</div>
        </div>

        <div id="debug-tool">
            <strong>座標偵測器 (開發者模式)</strong><br>
            請點擊模型上的任意位置...<br>
            <span id="coord-output">x: -, y: -, z: -</span>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // =========================================================
        // ▼▼▼ 【這裡是用戶設定區 (菜單)】 請修改這裡！ ▼▼▼
        // =========================================================
        const config = {
            // 1. 你的模型檔名 (記得把檔案上傳到 models 資料夾)
            filePath: './models/model3.glb', 

            // 2. 這裡設定模型的名字
            title: "工程安全帽 (測試版)",

            // 3. 這裡設定所有的標籤點
            points: [
                {
                    title: "帽殼",
                    text: "檢查是否有龜裂或遭受撞擊之白化痕跡，材質劣化時會變脆",
                    // 下面這三個數字，請用左下角的「座標偵測器」點出來填進去
                    pos: { x: 0, y: 0.15, z: 0.1 }, 
                    type: "danger" // danger(紅), info(藍)
                },
                // 如果要加第二個點，複製下面這一段：
                {
                    title: "帽緣/帽沿",
                    text: "確認無變形或缺損，這會影響導水與抗壓結構。",
                    pos: { x: 0.1, y: 0, z: 0 },
                    type: "danger"
                }
                
                {
                    title: "後方內襯",
                    text: "檢查懸掛帶是否斷裂，這是吸收衝擊力的關鍵。",
                    pos: { x: 0.1, y: 0, z: 0 },
                    type: "danger"
                }
            ]
        };
        // ▲▲▲ 設定區結束 ▲▲▲
        // =========================================================

        // 初始化場景
        const container = document.getElementById('canvas-wrapper');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.01, 100);
        camera.position.set(0.5, 0.5, 0.5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const light = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(light);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(2, 5, 2);
        scene.add(dirLight);

        // 載入模型
        const loader = new GLTFLoader();
        let loadedModel = null;
        
        // 顯示基本資訊
        document.getElementById('model-title').innerText = config.title;
        document.getElementById('description').innerText = "請旋轉模型並點擊標記點查看詳情。";

        loader.load(config.filePath, (gltf) => {
            loadedModel = gltf.scene;
            
            // 自動調整大小與位置
            const box = new THREE.Box3().setFromObject(loadedModel);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 0.5 / maxDim;
            
            loadedModel.position.sub(center);
            loadedModel.scale.multiplyScalar(scale);
            
            scene.add(loadedModel);
            createLabels(); // 產生標籤
        }, undefined, (err) => {
            console.error(err);
            alert("模型載入失敗！請檢查檔名是否正確：" + config.filePath);
        });

        // 產生標籤的函數
        const labelElements = [];
        function createLabels() {
            const labelsContainer = document.getElementById('labels-container');
            config.points.forEach((data, i) => {
                const div = document.createElement('div');
                div.className = `annotation ${data.type}`;
                div.innerText = i + 1;
                div.onclick = () => {
                    document.getElementById('model-title').innerText = data.title;
                    document.getElementById('description').innerText = data.text;
                };
                labelsContainer.appendChild(div);
                labelElements.push({ div, pos: new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z) });
            });
        }

        // ============================================
        // ★★★ 座標偵測器邏輯 (點擊模型顯示座標) ★★★
        // ============================================
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (event) => {
            if (!loadedModel) return;

            // 計算滑鼠位置
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(loadedModel, true);

            if (intersects.length > 0) {
                // 取得點擊點的座標
                const point = intersects[0].point;
                // 轉換回原始模型的相對座標 (抵銷縮放與位移)
                // 這是一個簡化版，直接顯示世界座標給使用者參考
                const x = point.x.toFixed(3);
                const y = point.y.toFixed(3);
                const z = point.z.toFixed(3);

                const msg = `座標: x: ${x}, y: ${y}, z: ${z}`;
                document.getElementById('coord-output').innerText = msg;
                
                // 複製到剪貼簿方便你用
                navigator.clipboard.writeText(`x: ${x}, y: ${y}, z: ${z}`).then(() => {
                    alert(`座標已複製！\n${msg}\n請去程式碼貼上取代舊座標。`);
                });
            }
        });

        // 動畫迴圈
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);

            // 更新標籤位置
            labelElements.forEach(item => {
                const pos = item.pos.clone();
                pos.project(camera);
                const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
                const y = (-(pos.y) * 0.5 + 0.5) * window.innerHeight;
                item.div.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
                
                // 簡單的背面隱藏 (如果跑到後面就不顯示)
                item.div.style.display = (pos.z > 1) ? 'none' : 'block';
            });
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
