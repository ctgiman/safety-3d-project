<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 工安教學平台</title>
    <style>
        body { margin: 0; font-family: 'Microsoft JhengHei', sans-serif; background: #2c3e50; color: white; overflow: hidden; }
        #container { position: relative; width: 100vw; height: 100vh; }
        
        /* 右側資訊欄 */
        #info-panel {
            position: absolute; right: 0; top: 0; bottom: 0; width: 300px;
            background: rgba(0, 0, 0, 0.8); padding: 20px; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 100;
        }
        h2 { color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .content-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; }

        /* 左上角模型切換選單 */
        #menu { position: absolute; top: 20px; left: 20px; z-index: 200; display: flex; gap: 10px; }
        .menu-btn { background: #34495e; color: white; border: 1px solid #3498db; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .menu-btn.active { background: #3498db; }

        /* 標籤樣式 */
        .annotation {
            position: absolute; width: 30px; height: 30px;
            background: rgba(0,0,0,0.6); border: 2px solid #fff; border-radius: 50%;
            cursor: pointer; color: #fff; font-weight: bold; text-align: center; line-height: 26px; z-index: 50;
        }
        .annotation.danger { border-color: #e74c3c; color: #e74c3c; }

        /* 開發者工具 */
        #debug-tool {
            position: absolute; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.9); border: 1px solid #00ff00; color: #00ff00;
            padding: 10px; font-family: monospace; font-size: 12px; z-index: 200;
        }
        .hide { display: none !important; }
    </style>
</head>
<body>

    <div id="container">
        <div id="menu"></div>

        <div id="canvas-wrapper" style="width:100%; height:100%;"></div>
        <div id="labels-container"></div>

        <div id="info-panel">
            <h2 id="model-title">載入中...</h2>
            <div id="description" class="content-box">請選擇模型</div>
        </div>

        <div id="debug-tool">
            <button onclick="document.getElementById('debug-tool').classList.add('hide')" style="float:right; cursor:pointer;">關閉工具</button>
            <strong>座標偵測器</strong><br>
            點擊模型自動複製座標<br>
            <span id="coord-output">x: -, y: -, z: -</span>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // =========================================================
        // ★★★ 資料庫：以後你只要在這裡加東西就好 ★★★
        // =========================================================
        const allModels = [
            {
                id: "helmet",
                btnName: "工程安全帽",
                filePath: './models/model3.glb',
                title: "工程安全帽檢查重點",
                points: [
                    { title: "帽殼頂部", text: "檢查是否有龜裂或遭受撞擊之白化痕跡，材質劣化時會變脆。", pos: { x: 0, y: 0.15, z: 0.1 }, type: "danger" },
                    { title: "帽帶", text: "確認頤帶功能正常。", pos: { x: 0, y: -0.1, z: 0 }, type: "danger" },
                    { title: "內襯", text: "檢查是否有龜裂。", pos: { x: 0, y: 0.15, z: 0.1 }, type: "danger" },
                    { title: "帽緣/帽沿", text: "確認無變形或缺損，這會影響導水與抗壓結構。", pos: { x: 0, y: 0.15, z: 0.1 }, type: "danger" },
                ]
            },
            {
                id: "fire",
                btnName: "滅火器",
                filePath: './models/fireextinguisher.glb',
                title: "滅火器檢查重點",
                points: [
                    { title: "壓力錶指針", text: "指針必須位於綠色區塊。若偏左表示壓力不足，偏右則壓力過大，皆需重新填充藥劑。", pos: { x: 0.05, y: 0.1, z: 0.05 }, type: "danger" },
                    { title: "瓶身狀態", text: "檢查有無嚴重生鏽、腐蝕或變形。鋼瓶若生鏽嚴重，在使用時可能有爆裂風險。", pos: { x: -0.05, y: 0.15, z: 0 }, type: "danger" },
                    { title: "安全插梢", text: "確認插梢是否固定完好，無被拔除或損壞。", pos: { x: 0.05, y: 0.1, z: 0.05 }, type: "danger" },
                    { title: "皮管與噴嘴", text: "檢查有無老化斷裂、阻塞或鬆脫現象。", pos: { x: 0.05, y: 0.1, z: 0.05 }, type: "danger" },
                ]
            }
            // 以後要加新的，直接複製上面一整段貼在這邊
        ];

        // =========================================================
        // 核心邏輯
        // =========================================================
        let currentModelObj = null;
        let loadedModel = null;
        const labelElements = [];
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.01, 100);
        camera.position.set(0.5, 0.5, 0.5);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-wrapper').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const light = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(light);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(2, 5, 2);
        scene.add(dirLight);

        const loader = new GLTFLoader();

        // 載入模型的函數
        function loadModelById(id) {
            // 1. 清除舊東西
            if (loadedModel) scene.remove(loadedModel);
            document.getElementById('labels-container').innerHTML = "";
            labelElements.length = 0;

            // 2. 找到資料
            currentModelObj = allModels.find(m => m.id === id);
            document.getElementById('model-title').innerText = currentModelObj.title;
            document.getElementById('description').innerText = "載入中...";

            // 3. 執行載入
            loader.load(currentModelObj.filePath, (gltf) => {
                loadedModel = gltf.scene;
                const box = new THREE.Box3().setFromObject(loadedModel);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const scale = 0.5 / Math.max(size.x, size.y, size.z);
                
                loadedModel.position.sub(center);
                loadedModel.scale.multiplyScalar(scale);
                scene.add(loadedModel);
                
                document.getElementById('description').innerText = "點擊數字標籤查看說明";
                createLabels(currentModelObj.points);
            });
        }

        function createLabels(points) {
            const container = document.getElementById('labels-container');
            points.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = `annotation ${p.type}`;
                div.innerText = i + 1;
                div.onclick = () => {
                    document.getElementById('model-title').innerText = p.title;
                    document.getElementById('description').innerText = p.text;
                };
                container.appendChild(div);
                labelElements.push({ div, pos: new THREE.Vector3(p.pos.x, p.pos.y, p.pos.z) });
            });
        }

        // 建立選單按鈕
        const menu = document.getElementById('menu');
        allModels.forEach(m => {
            const btn = document.createElement('button');
            btn.className = "menu-btn";
            btn.innerText = m.btnName;
            btn.onclick = () => {
                document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                loadModelById(m.id);
            };
            menu.appendChild(btn);
        });

        // 預設載入第一個
        menu.firstChild.click();

        // 座標偵測邏輯
        window.addEventListener('click', (event) => {
            if (!loadedModel) return;
            const mouse = new THREE.Vector2(
                (event.clientX / window.innerWidth) * 2 - 1,
                -(event.clientY / window.innerHeight) * 2 + 1
            );
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(loadedModel, true);

            if (intersects.length > 0) {
                const p = intersects[0].point;
                const coordStr = `x: ${p.x.toFixed(3)}, y: ${p.y.toFixed(3)}, z: ${p.z.toFixed(3)}`;
                document.getElementById('coord-output').innerText = coordStr;
                navigator.clipboard.writeText(coordStr);
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            labelElements.forEach(item => {
                const pos = item.pos.clone().project(camera);
                item.div.style.transform = `translate(-50%, -50%) translate(${(pos.x * 0.5 + 0.5) * window.innerWidth}px, ${(-(pos.y) * 0.5 + 0.5) * window.innerHeight}px)`;
                item.div.style.display = (pos.z > 1) ? 'none' : 'block';
            });
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
